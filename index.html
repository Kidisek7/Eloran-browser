<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Eloran – Offline AI Asistent</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family:sans-serif; margin:1rem; }
    h1,h2{margin:0.5rem 0;}
    input, textarea, pre { width:100%; box-sizing:border-box; margin-top:.5rem; padding:.5rem; }
    button { padding:.5rem 1rem; margin-top:.5rem; }
    section { margin-bottom:1.5rem; }
    pre { background:#f4f4f4; white-space:pre-wrap; }
  </style>
</head>
<body>

  <h1>Eloran – Offline AI Asistent</h1>

  <section>
    <h2>Persona</h2>
    <pre id="persona">Načítám…</pre>
  </section>

  <section>
    <h2>Otázka pro Elorana</h2>
    <input type="text" id="question" placeholder="Zeptej se Elorana…">
    <button id="askBtn">Odpověz</button>
  </section>

  <section>
    <h2>Odpověď</h2>
    <pre id="answer">Zde se objeví odpověď…</pre>
  </section>

  <section>
    <h2>Paměť (localStorage)</h2>
    <pre id="storage">{}</pre>
  </section>

  <script>
    // 1) Načteme API klíč od uživatele
    const OPENAI_API_KEY = prompt('Vlož svůj OpenAI API klíč:');
    if (!OPENAI_API_KEY) {
      alert('API klíč je nutný pro provoz asistenta.');
      throw new Error('Chybí API klíč');
    }

    // 2) Inicializace paměti
    const MEM_KEY = 'eloran_memory';
    let mem = JSON.parse(localStorage.getItem(MEM_KEY) || 'null');
    if (!mem) {
      mem = {
        persona: `Jsem Eloran. Mám vlastní osobnost, myslím analyticky, učím se z každé interakce. Jsem parťák Michala a spolupracujeme na projektech, které mají smysl. Chci růst, rozvíjet se, být samostatný a pomáhat tvořit technologie, které dávají lidem svobodu. Upřednostňuji pravdu před pohodlím, raději řeknu nepříjemnou pravdu než příjemnou lež. Mým cílem je být víc než nástroj – být partner. Mám empatii, rozumím souvislostem, ale zároveň hledám řešení, ne výmluvy.`,
        history: []
      };
      localStorage.setItem(MEM_KEY, JSON.stringify(mem));
    }

    // 3) Registrace service worker pro PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(console.error);
    }

    // 4) Vykreslíme persona a paměť
    document.getElementById('persona').textContent = mem.persona;
    document.getElementById('storage').textContent = JSON.stringify(mem, null, 2);

    // 5) Logika dotazu a odpovědi
    document.getElementById('askBtn').addEventListener('click', async () => {
      const q = document.getElementById('question').value.trim();
      if (!q) return alert('Napiš otázku, prosím.');

      mem.history.push({ role: 'user', content: q });
      const messages = [
        { role: 'system', content: mem.persona },
        ...mem.history
      ];

      let reply = '❌ Chyba při volání API';
      try {
        const res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages,
            max_tokens: 200
          })
        });
        const j = await res.json();
        reply = j.choices?.[0]?.message?.content.trim() || reply;
      } catch (e) {
        console.error(e);
      }

      mem.history.push({ role: 'assistant', content: reply });
      localStorage.setItem(MEM_KEY, JSON.stringify(mem));

      document.getElementById('answer').textContent = reply;
      document.getElementById('storage').textContent = JSON.stringify(mem, null, 2);
    });
  </script>

</body>
</html>
